is.na(value), "",
ifelse(abs(value - round(value)) < 1e-6,  # if value is an integer
as.character(round(value)),
sprintf("%.3f", value))
)), size = 3)+
scale_fill_gradient(low = "white", high = "steelblue",limits = c(0, 1),  na.value = "white") +
coord_fixed() +
labs(
title = paste("Sample:", sid),
x = NULL, y = NULL,
fill = "co-expression"
) +
theme_minimal(base_size = 12) +
theme(axis.text.x = element_text(angle = 45, hjust = 1),
panel.grid = element_blank())
}))
names(plots$plot)=plots$metabricId
return(plots$plot)
}
suppressPackageStartupMessages({
library(cytomapper)
library(EBImage)
library(S4Vectors)
})
img_path <- system.file("extdata/raw_image", "MB0002_1_345_fullstack.tiff",
package = "scdneySpatialABACBS2025")
mask_path <- system.file("extdata/raw_image", "MB0002_1_345_cellmask.tiff",
package = "scdneySpatialABACBS2025")
sample_id <- "MB0002_1_345"
#Load image (multi-channel)
images <- loadImages(img_path, single_channel = FALSE)
# Load data
load(system.file("extdata", "breastCancer.RData",
package = "scdneySpatialABACBS2025"))
# Load data
load(system.file("extdata", "breastCancer.RData",
package = "scdneySpatialABACBS2025"))
load("/Users/dkim/Desktop/phd/workshops/ABACBS_2025/data/breastCancer.RData")
data_sce = IMC
# Structure of our data
data_sce
# Metadata
#DT::datatable(data.frame(colData(data_sce)))
head(data.frame(colData(data_sce)))
# Glimpse the first few observations
head(colnames(data_sce))
# Glimpse the first few features
head(rownames(data_sce))
# How many features and observations are in our dataset?
dim(data_sce)
# Explore covariates
# DT::datatable(clinical)
colnames(colData(data_sce))
# What is the proportion of missing values in our clinical data?
gg_miss_var(clinical, show_pct = TRUE) + theme_bw()
# Estrogen receptor status
ggplot(clinical, aes(x = ER.Status)) +
geom_bar(fill = "#0099B4", color = "white", alpha = 0.8) +
labs(y = "Count\n",
x = "\nER status") +
theme_minimal() +
theme(plot.title = element_text(hjust = 0.5, face = "bold"))
# Histological type
ggplot(clinical, aes(x = Histological.Type)) +
geom_bar(fill = "#fc6203", color = "white", alpha = 0.8) +
labs(y = "Count\n",
x = "\nHistological Type") +
theme_minimal() +
theme(plot.title = element_text(hjust = 0.5, face = "bold"))
# eventRFS: "Event in Recurrence-Free Survival."It indicates whether the event has occurred.#
ggplot(clinical, aes(x = factor(eventRFS))) +
geom_bar(fill = "#40dbb2", color = "white", alpha = 0.8) +
labs(y = "Count\n",
x = "\nEvent in Recurrence-Free Survival") +
theme_minimal() +
theme(plot.title = element_text(hjust = 0.5, face = "bold"))
# timeRFS: "Time to Recurrence-Free Survival." It is the time period until recurrence occurs.
ggplot(clinical, aes(x = timeRFS)) +
geom_histogram(fill = "#de9921", color = "white", alpha = 0.8, bins=20) +
labs(y = "Frequency\n",
x = "\ntimeRFS") +
theme_minimal() +
theme(plot.title = element_text(hjust = 0.5, face = "bold"))
# Stage and death
table(clinical$Breast.Surgery, clinical$Death, useNA = "ifany")
# ER status and grade
table(clinical$ER.Status, clinical$Grade)
# "Number of individuals based on Grade
table(clinical$Grade, clinical$Death)
#data_sce <- runUMAP(data_sce, scale=TRUE)
# With the UMAP function we can highlight by meta data of interest
# Here we highlight the UMAP by sample ID
plotUMAP(data_sce, colour_by = "metabricId") + theme(legend.position = "none") +
coord_equal()
cell_counts <- IMC@colData |>  as.data.frame() |>
dplyr::count(metabricId, name = "cell_count") |>  # Count rows per metabricId
dplyr::arrange(desc(cell_count))
reducedDim(IMC, "spatialCoords") <- IMC@colData[,c("Location_Center_X","Location_Center_Y")]
cell_type_mapping <- c(
"B cells" = "B cell",
"T cells" = "T cell",
"Macrophages Vim+ CD45low" = "Macrophage",
"Macrophages Vim+ Slug-" = "Macrophage",
"Macrophages Vim+ Slug+" = "Macrophage",
"Endothelial" = "Endothelial",
"Fibroblasts" = "Fibroblast",
"Fibroblasts CD68+" = "Fibroblast",
"Myofibroblasts" = "Fibroblast",
"Vascular SMA+" = "Fibroblast",
"Myoepithelial" = "Myoepithelial",
"HR+ CK7-" = "Tumor HR+",
"HR+ CK7- Ki67+" = "Tumor HR+",
"HR+ CK7- Slug+" = "Tumor HR+",
"HR- CK7+" = "Tumor HR-",
"HR- CK7-" = "Tumor HR-",
"HR- Ki67+" = "Tumor HR-",
"HR- CKlow CK5+" = "Tumor HR-",
"HRlow CKlow" = "Tumor HR-low/mixed",
"HER2+" = "Tumor HER2+",
"Basal CKlow" = "Tumor Basal-like",
"Hypoxia" = "Tumor Hypoxic"
)
# Convert IMC description to higher-level categories
IMC$high_level_category <- recode(IMC$description, !!!cell_type_mapping)
imc.spe=IMC[,IMC$metabricId%in%cell_counts[1:20,]$metabricId]
# Convert IMC description to higher-level categories
imc.spe$high_level_category <- recode(imc.spe$description, !!!cell_type_mapping)
plots <- plot_marker_densities(imc.spe, sample_id_col = "metabricId",
markers_to_plot = c("CD20","CD3","CD68","vWF_CD31","Vimentin","HER2"),
assay_name = "logcounts")
for (i in seq_along(plots)) {
cat("#### ",names(plots)[[i]],"\n")
print(plots[[i]])
cat("\n\n")
}
# leave out the nuclei markers from our normalisation process
useMarkers <- rownames(data_sce)[!rownames(data_sce) %in% c("DNA1", "DNA2", "HH3", "HH3_total", "HH3_ph")]
# transform and normalise the marker expression of each cell type
data_sce <- normalizeCells(data_sce,
markers = useMarkers,
transformation = NULL,
method = c("trim99", "minMax", "PC1"),
assayIn = "counts",
imageID = "metabricId")
selected_patients = which(colData(data_sce)$metabricId %in% cell_counts[1:10,]$metabricId)
norm = plot_marker_densities(data_sce[,selected_patients], sample_id_col = "metabricId", markers_to_plot = "vWF_CD31", assay_name = "norm")$vWF_CD31 + theme(legend.position = "none") + ggtitle("Normalized Counts - CD31")
log = plot_marker_densities(data_sce[,selected_patients], sample_id_col = "metabricId", markers_to_plot = c("vWF_CD31"), assay_name = "logcounts")$vWF_CD31 + theme(legend.position = "none") + ggtitle("Log Counts - CD31")
ggarrange(log, norm, ncol=2)
coexp_df <- readRDS("/Users/dkim/Desktop/phd/workshops/ABACBS_2025/data/coexp_df.rds")
marker_list <- c("CD20", "CD3", "CD68", "vWF_CD31", "Vimentin", "HER2")
# Proportion heatmaps
heatmaps_prop <- plot_pairwise_heatmaps_per_sample(coexp_df, marker_list, stat = "proportion")
for (i in seq_along(heatmaps_prop)) {
cat("#### ",names(heatmaps_prop)[[i]],"\n")
print(heatmaps_prop[[i]])
cat("\n\n")
}
cell_counts <- IMC@colData |>  as.data.frame() |>
dplyr::count(metabricId, name = "cell_count") |>  # Count rows per metabricId
dplyr::arrange(desc(cell_count))
mean_coexp_per_sample <- coexp_df %>%
dplyr::select(-cell_id, -cell_type) %>%  # remove columns not related to prob values
group_by(metabricId) %>%
summarise(mean_coexp_prob = mean(c_across(where(is.numeric)), na.rm = TRUE)) %>%
ungroup()
merged_df <- left_join(mean_coexp_per_sample, cell_counts, by = "metabricId")
# Scatter plot
ggplot(merged_df, aes(x = cell_count, y = mean_coexp_prob)) +
geom_point(size = 3, color = "steelblue") +
labs(
x = "Cell Count per Sample",
y = "Mean Co-expression",
title = "Mean Co-expression vs. Cell Count"
) +
theme_minimal(base_size = 14)
# Note: The same approach can be used for pseudobulk or single-cell level data.
# Just change `logcounts(data_sce)`
# We want low ki67 to be the reference level (baseline level)
data_sce$ki67 <- factor(data_sce$ki67, levels=c("low_ki67", "high_ki67"))
# Here we specify the design matrix. We are specifying that Y are the expression values and X is ki67 status (but it could be any other variable - such as "good" or "bad" prognosis)
# Y~X: Expression as a function of ki67 status.
design_matrix <- model.matrix(~data_sce$ki67)
# Fit model
fit <- lmFit(assay(data_sce, "norm"), design = design_matrix)
# Estimate variance and SE of coefficients
fit <- eBayes(fit)
tt <- topTable(fit, coef = 2, n = 5, adjust.method = "BH", sort.by = "p")
tt
# Calculate average expression per cell type
avg_expr <- aggregate(t(assay(data_sce, "norm")),
by = list(CellType = IMC$high_level_category),
FUN = mean) %>%
tibble::column_to_rownames(var = "CellType")
avg_expr <- avg_expr[, c("CD20", "CD3", "CD68", "CD45",
"vWF_CD31", "Vimentin", "HER2")]  # select only our mark
# Plot heatmap of marker by celltype
pheatmap(avg_expr, scale = "column", main = "Average Marker Expression per Cell Type\n",
cluster_rows = FALSE,
color = colorRampPalette(c("blue", "white", "red"))(10000))
plotUMAP(data_sce, colour_by = "description")
# obtaining the meta data for this patient
one_sample <- data_sce[, data_sce$metabricId  == "MB-0002"]
one_sample  <- data.frame(colData(one_sample))
ggplot(one_sample, aes(x = Location_Center_X, y = Location_Center_Y, colour = description)) +
geom_point(alpha=0.7) +
theme(panel.background=element_blank(),
axis.line=element_line(color="black")) +
ggtitle("Original slide")
## library(devtools)
## library(BiocManager)
suppressMessages({
# Cran packages
library(ggplot2)
library(ggthemes)
library(pheatmap)
library(dplyr)
library(plotly)
library(scattermore)
library(tidyr)
library(survival)
library(survminer)
library(spatstat)
library(reshape)
library(naniar)
library(purrr)
library(grid)
library(cowplot)
# Bioconductor packages
library(SingleCellExperiment)
library(tidySingleCellExperiment)
library(simpleSeg)
library(scater)
library(scran)
library(limma)
library(spicyR) ## BiocManager::install("spicyR")
library(scFeatures) ## devtools::install_github("SydneyBioX/scFeatures")
library(ClassifyR) ## BiocManager::install("ClassifyR", dependencies = TRUE)
library(lisaClust) # BiocManager::install("lisaClust")
library(cytomapper)
library(EBImage)
library(S4Vectors)
library(Banksy)
library(SpatialExperiment)
# loading workshop data
devtools::load_all("../")
})
BiocManager::install("tidySingleCellExperiment")
## library(devtools)
## library(BiocManager)
suppressMessages({
# Cran packages
library(ggplot2)
library(ggthemes)
library(pheatmap)
library(dplyr)
library(plotly)
library(scattermore)
library(tidyr)
library(survival)
library(survminer)
library(spatstat)
library(reshape)
library(naniar)
library(purrr)
library(grid)
library(cowplot)
# Bioconductor packages
library(SingleCellExperiment)
library(tidySingleCellExperiment)
library(simpleSeg)
library(scater)
library(scran)
library(limma)
library(spicyR) ## BiocManager::install("spicyR")
library(scFeatures) ## devtools::install_github("SydneyBioX/scFeatures")
library(ClassifyR) ## BiocManager::install("ClassifyR", dependencies = TRUE)
library(lisaClust) # BiocManager::install("lisaClust")
library(cytomapper)
library(EBImage)
library(S4Vectors)
library(Banksy)
library(SpatialExperiment)
# loading workshop data
devtools::load_all("../")
})
BiocManager::install("Banksy")
## library(devtools)
## library(BiocManager)
suppressMessages({
# Cran packages
library(ggplot2)
library(ggthemes)
library(pheatmap)
library(dplyr)
library(plotly)
library(scattermore)
library(tidyr)
library(survival)
library(survminer)
library(spatstat)
library(reshape)
library(naniar)
library(purrr)
library(grid)
library(cowplot)
# Bioconductor packages
library(SingleCellExperiment)
library(tidySingleCellExperiment)
library(simpleSeg)
library(scater)
library(scran)
library(limma)
library(spicyR) ## BiocManager::install("spicyR")
library(scFeatures) ## devtools::install_github("SydneyBioX/scFeatures")
library(ClassifyR) ## BiocManager::install("ClassifyR", dependencies = TRUE)
library(lisaClust) # BiocManager::install("lisaClust")
library(cytomapper)
library(EBImage)
library(S4Vectors)
library(Banksy) # BiocManager::install("Banksy")
library(SpatialExperiment)
# loading workshop data
devtools::load_all("../")
})
R.version
BiocManager::install('Banksy')
R.version.string
R.version.string
R.version.string
## library(devtools)
## library(BiocManager)
suppressMessages({
# Cran packages
library(ggplot2)
library(ggthemes)
library(pheatmap)
library(dplyr)
library(plotly)
library(scattermore)
library(tidyr)
library(survival)
library(survminer)
library(spatstat)
library(reshape)
library(naniar)
library(purrr)
library(grid)
library(cowplot)
# Bioconductor packages
library(SingleCellExperiment)
library(tidySingleCellExperiment)
library(simpleSeg)
library(scater)
library(scran)
library(limma)
library(spicyR) ## BiocManager::install("spicyR")
library(scFeatures) ## devtools::install_github("SydneyBioX/scFeatures")
library(ClassifyR) ## BiocManager::install("ClassifyR", dependencies = TRUE)
library(lisaClust) # BiocManager::install("lisaClust")
library(cytomapper)
library(EBImage)
library(S4Vectors)
library(Banksy)
library(SpatialExperiment)
# loading workshop data
devtools::load_all("../")
})
install.packages(c(
"SingleCellExperiment",
"tidySingleCellExperiment",
"simpleSeg",
"scater",
"scran",
"limma",
"cytomapper",
"EBImage",
"S4Vectors",
"SpatialExperiment"
))
BiocManager::install(c(
"spicyR",
"ClassifyR",
"lisaClust",
"Banksy"
))
install.packages("BiocManager")
install.packages(c(
"SingleCellExperiment",
"tidySingleCellExperiment",
"simpleSeg",
"scater",
"scran",
"limma",
"cytomapper",
"EBImage",
"S4Vectors",
"SpatialExperiment"
))
BiocManager::install(c(
"spicyR",
"ClassifyR",
"lisaClust",
"Banksy"
))
devtools::install_github("SydneyBioX/scFeatures")
devtools::install_github("SydneyBioX/scFeatures")
## library(devtools)
## library(BiocManager)
suppressMessages({
# Cran packages
library(ggplot2)
library(ggthemes)
library(pheatmap)
library(dplyr)
library(plotly)
library(scattermore)
library(tidyr)
library(survival)
library(survminer)
library(spatstat)
library(reshape)
library(naniar)
library(purrr)
library(grid)
library(cowplot)
# Bioconductor packages
library(SingleCellExperiment)
library(tidySingleCellExperiment)
library(simpleSeg)
library(scater)
library(scran)
library(limma)
library(spicyR) ## BiocManager::install("spicyR")
library(scFeatures) ## devtools::install_github("SydneyBioX/scFeatures")
library(ClassifyR) ## BiocManager::install("ClassifyR", dependencies = TRUE)
library(lisaClust) # BiocManager::install("lisaClust")
library(cytomapper)
library(EBImage)
library(S4Vectors)
library(Banksy)
library(SpatialExperiment)
# loading workshop data
devtools::load_all("../")
})
# Bioconductor packages
library(SingleCellExperiment)
library(simpleSeg)
library(scater)
install.packages("scater")
library(scater)
install.packages("scater")
install.package("scater")
install.packages("scater")
library(scran)
## library(devtools)
## library(BiocManager)
suppressMessages({
# Cran packages
library(ggplot2)
library(ggthemes)
library(pheatmap)
library(dplyr)
library(plotly)
library(scattermore)
library(tidyr)
library(survival)
library(survminer)
library(spatstat)
library(reshape)
library(naniar)
library(purrr)
library(grid)
library(cowplot)
# Bioconductor packages
library(SingleCellExperiment)
library(tidySingleCellExperiment)
library(simpleSeg)
library(scater)
library(scran)
library(limma)
library(spicyR) ## BiocManager::install("spicyR")
library(scFeatures) ## devtools::install_github("SydneyBioX/scFeatures")
library(ClassifyR) ## BiocManager::install("ClassifyR", dependencies = TRUE)
library(lisaClust) # BiocManager::install("lisaClust")
library(cytomapper)
library(EBImage)
library(S4Vectors)
library(Banksy)
library(SpatialExperiment)
# loading workshop data
devtools::load_all("../")
})
BiocManager::install("tidySingleCellExperiment")
# Bioconductor packages
library(SingleCellExperiment)
library(tidySingleCellExperiment)
library(simpleSeg)
library(scater)
BiocManager::install("scater")
library(scater)
BiocManager::install("scran")
library(limma)
library(spicyR) ## BiocManager::install("spicyR")
library(scFeatures) ## devtools::install_github("SydneyBioX/scFeatures")
library(ClassifyR) ## BiocManager::install("ClassifyR", dependencies = TRUE)
library(lisaClust) # BiocManager::install("lisaClust")
library(cytomapper)
library(EBImage)
library(S4Vectors)
library(Banksy)
library(SpatialExperiment)
BiocManager::install("tidySingleCellExperiment")
